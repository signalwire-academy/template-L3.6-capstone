name: Grade Lab

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  grade:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install signalwire-agents
      
      - name: Grade lab
        id: grade
        uses: signalwire-academy/swaig-grader@v1
        with:
          agent-file: solution/agent.py
          checks: |
            instantiate
            swml_valid
      
      - name: Notify progress tracker
        if: always()
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.PROGRESS_TOKEN }}
          repository: signalwire-academy/progress-tracker
          event-type: grading-complete
          client-payload: |
            {{
              "repo": "${{ github.repository }}",
              "student": "${{ github.repository_owner }}",
              "lab": "L3.6",
              "result": "${{ steps.grade.outcome }}",
              "sha": "${{ github.sha }}"
            }}
